# ECS

## TODO
* 组件间不变式的自动初始化：如碰撞箱的变化跟随主变换

## 实体有效性

* 任何实体的资源的添加必须延迟到帧后，添加实体的立即调用仅返回对实体的一个引用，其资源将在下一帧有效，即使它是被有状态添加的
* 对实体的延迟添加/释放（标记）操作是线程安全的
* 若实体已经有效，那么它所有资源的引用和实体本身的引用的有效性至少保留到当前帧结束
* 实体必须被**显式**标记过期。即使引用计数归零，实体仍然会保留
* 实体本身的引用仅当引用计数归零时由Manger释放并失效
* 任何**跨帧保有**对其它实体引用的对象应当在每帧检查被引用实体是否仍旧有效，并主动释放已失效实体

### 实体状态
<div style="text-align: center;scale: 150%">[Staging, <b>Valid</b>, Expired, <i>Destroyed</i>] </div>

1. Staging: 在调用延迟添加后，在处理延迟添加前：实体无法获取获取到其组件，组件尚未调用来自trait的各部分初始化和组件全体初始化
2. Valid: 在处理延迟添加后，在实体被标记过期前：实体在逻辑上有意义，实体确保对所有组件是可访问的。
3. Expired: 实体被***标记***为弃用，此时对实体本身的引用仍然有效，但是对其各组件不可访问
4. Destroyed: *仅阐释*，实体已被回收，不应以任何方式使用旧的引用进行访问。

| Accessibility | Staging | Valid | Expired |
|---------------|---------|-------|---------|
| Archetype     | [x]     | [x]   | [ ]     |
| Component     | [ ]     | [x]   | [ ]     |
| Entity ID     | [x]     | [x]   | [x]     |
